<template>
    <div id="singleImage" class="m-Upload">
        <!-- 图片显示 -->
        <div v-if="getImageUrl != ''" class="upload-show">
            <img class="upload-image" :src="getImageUrl" alt="图片加载失败" @error="notFoundPic"/>
            <!-- 可预览遮罩 -->
            <div v-if="preview" class="upload-mask">
                <Icon type="eye" @click.native="viewImage"></Icon>
            </div>
        </div>
        <!-- 上传按钮 -->
        <Button type="ghost" :loading="loading" icon="ios-cloud-upload-outline" @click="uploadImg">上传图片</Button>
        <input
            ref="imgFile"
            type="file"
            :accept="format"
            style="FILTER: alpha(opacity=0); moz-opacity: 0; opacity: 0;"
            @change="selectFile"
        />
        <!-- 上传进度条  -->
        <template v-if="uploadStatus != 'finished'">
            <Progress v-if="showProgress" :percent="percentage" :stroke-width="3" style="width:340px;"></Progress>
        </template>
        <br/>
        <!-- 图片格式提示 -->
        <span class="hint">* 图片格式要求：jpg、jpeg、png，文件大小为2M以内。</span>
        <div class="clearfix"></div>
        <!-- 查看图片 -->
        <Modal title="查看图片" v-model="showModal">
            <img :src="getImageUrl" style="width: 100%" @error="notFoundPic"/>
            <div slot="footer"></div>
        </Modal>
    </div>
</template>
<script>
    import Common from 'common/common.js'
    import { mapGetters } from 'vuex'

    export default {
        name: 'singleImage',
        // 获取父级传值preview，true为可预览图片，false为不可预览
        props: [ 'preview' ],
        computed: {
            ...mapGetters([
                // 获取图片显示路径
                'getImageUrl',
            ])
        },
        data () {
            return {
                // 上传加载  
                loading: false,                
                // 显示遮罩
                showMask: false,
                // 显示查看图片
                showModal: false,
                // 是否显示图片
                visible: true,
                // 图片文件大小
                maxSize: 2048,
                // 可接受的图片上传格式
                format: ['image/gif', 'image/jpeg', 'image/png'],
                // 上传状态，上传成功完成为finished
                uploadStatus: '',
                // 是否显示进度条
                showProgress: false,
                // 上传进度
                percentage: 0,
            }
        },
        created(){
            // 设置图片要存储的文件目录，以当年作为数值
            this.dir = new Date().getFullYear();
        },
        methods: {
            // 查看图片
            viewImage(){
                this.showModal = true;
            },
            // 上传图片
            uploadImg(){
                // 触发input按钮点击事件
                this.$refs.imgFile.click();
            },
            // 选择文件
            selectFile(event){
                const fileList = this.$refs.imgFile.files;
                if(fileList.length > 0){
                    // 文件名
                    let fileName = fileList[0].name;
                    // 文件大小
                    let fileSize = Math.floor(fileList[0].size / 1024);
                    // 控制文件大小
                    if(fileSize > this.maxSize){
                        this.$Notice.warning({
                            title: '超出文件大小限制',
                            desc: '文件 ' + fileName + ' 太大，不能超过 ' + 2 + 'M。'
                        });
                        return false;
                    }
                    var fileUploadControl = $("#profilePhotoFileUpload")[0];
                    // 上传有跨域问题，不可用
                    var file = new Bmob.File(fileName, fileList[0]);     
                    file.save().then(function(obj) {
                        alert(obj.url());
                    }, function(error) {
                        console.log(error);
                    });
                }
                else console.log('获取不到文件列表');
            },
            // 无法显示图片
            notFoundPic(event){
                Common.SetDefaultPic(event, 2);
            },            
        }
    }
</script>
<style lang="less" scoped>
    .hint{
        color:#ed3f14;
        margin-top: 15px;
    }
    
    .upload-show{
        float: left;
        position: relative;
        min-width: 90px;
        height: 90px;
        margin-right: 15px;
        border: 1px solid #e4e5e7;
        border-radius: 4px;
        overflow: hidden;
        text-align: center;
        &:hover{
            .upload-mask{
                display: block;
            }
        }   
    }
    .upload-mask{
        cursor: pointer;
        display: none;
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
        background: rgba(0,0,0,0.8);
        border-radius: 4px;
        text-align: center;
        .ivu-icon{
            color:#fff;
            line-height: 90px;
            font-size: 20px;
        }
    }
    .upload-image{
        height: 100%;
        border-radius: 4px;
        max-width: 350px;
    }
</style>